# Kubernetes Secrets and Hashicorp Vault

## Task 1

### Create a Secret Using `kubectl`

```sh
$ kubectl create secret generic my-secret --from-literal=username='admin' --from-literal=password='admin1234'
secret/my-secret created
```

```sh
$ kubectl get secrets
NAME                                   TYPE                 DATA   AGE
my-secret                              Opaque               2      2m27s
```

### Verify and Decode Secret

```sh
 kubectl describe secret my-secret
Name:         my-secret
Namespace:    default
Labels:       <none>
Annotations:  <none>

Type:  Opaque

Data
====
password:  9 bytes
username:  5 bytes
```

```sh
$ kubectl get secrets my-secret -o yaml
apiVersion: v1
data:
  password: YWRtaW4xMjM0
  username: YWRtaW4=
kind: Secret
metadata:
  creationTimestamp: "2024-04-16T12:38:17Z"
  name: my-secret
  namespace: default
  resourceVersion: "12950"
  uid: f3a8699c-d0ca-4009-a0cc-33e9e359a3c0
type: Opaque
```

```sh
$ kubectl get secret my-secret -o jsonpath='{.data.password}' | base64 --decode 
admin1234
```

### Manage Secrets with Helm

```sh
$ helm secrets view secrets.yaml
password: admin1234
```

```sh
$ helm secrets upgrade --install app-python-secret . -n default -f secrets.yaml
Release "app-python-secret" has been upgraded. Happy Helming!
NAME: app-python-secret
LAST DEPLOYED: Tue Apr 16 22:42:19 2024
NAMESPACE: default
STATUS: deployed
REVISION: 2
NOTES:
1. Get the application URL by running these commands:
  export NODE_PORT=$(kubectl get --namespace default -o jsonpath="{.spec.ports[0].nodePort}" services app-python-secret)
  export NODE_IP=$(kubectl get nodes --namespace default -o jsonpath="{.items[0].status.addresses[0].address}")
  echo http://$NODE_IP:$NODE_PORT
removed 'secrets.yaml.dec'
```

```sh
$ kubectl get po
NAME                                 READY   STATUS             RESTARTS   AGE
app-dart-c6ffc8975-m2lng             0/1     ImagePullBackOff   0          7d4h
app-python-7f7b696cc7-z5zrv          1/1     Running            0          2m35s
app-python-secret-66cbb64fd8-6j7s4   1/1     Running            0          24s

```

```sh
$ kubectl exec app-python-secret-66cbb64fd8-6j7s4 -- printenv | grep PASSWORD
MY_PASSWORD=admin1234
```

## Task 2

````sh
$ kubectl exec -it app-python-secret-5f455ff8bf-k7dbb  -- sh
Defaulted container "app-python" out of: app-python, vault-agent, vault-agent-init (init)
/app_python $ cat /vault/secrets/database-config.txt 
postgresql://db-readonly-username:db-secret-password@postgres:5432/wizard
````

```sh
$ kubectl exec -it app-python-secret-5f455ff8bf-k7dbb  -- /bin/df -h
Defaulted container "app-python" out of: app-python, vault-agent, vault-agent-init (init)
Filesystem                Size      Used Available Use% Mounted on
overlay                 915.8G     80.9G    788.4G   9% /
tmpfs                    64.0M         0     64.0M   0% /dev
tmpfs                   256.0M      4.0K    256.0M   0% /vault/secrets
/dev/nvme0n1p1          915.8G     80.9G    788.4G   9% /dev/termination-log
/dev/nvme0n1p1          915.8G     80.9G    788.4G   9% /etc/resolv.conf
/dev/nvme0n1p1          915.8G     80.9G    788.4G   9% /etc/hostname
/dev/nvme0n1p1          915.8G     80.9G    788.4G   9% /etc/hosts
shm                      64.0M         0     64.0M   0% /dev/shm
tmpfs                   256.0M     12.0K    256.0M   0% /run/secrets/kubernetes.io/serviceaccount
tmpfs                    62.8G         0     62.8G   0% /proc/asound
tmpfs                    62.8G         0     62.8G   0% /proc/acpi
tmpfs                    64.0M         0     64.0M   0% /proc/kcore
tmpfs                    64.0M         0     64.0M   0% /proc/keys
tmpfs                    64.0M         0     64.0M   0% /proc/timer_list
tmpfs                    62.8G         0     62.8G   0% /proc/scsi
tmpfs                    62.8G         0     62.8G   0% /sys/firmware
```
